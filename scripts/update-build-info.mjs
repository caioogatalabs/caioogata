import { execSync } from 'child_process'
import { writeFileSync } from 'fs'
import { join, dirname } from 'path'
import { fileURLToPath } from 'url'

const __dirname = dirname(fileURLToPath(import.meta.url))
const root = join(__dirname, '..')

let count = 1
try {
  const current = parseInt(execSync('git rev-list --count HEAD', { encoding: 'utf8' }).trim(), 10)
  count = current + 1
} catch {
  // not in a git repo or git unavailable — keep fallback
}

const content = `// Auto-generated by scripts/update-build-info.mjs — do not edit manually\nexport const COMMIT_COUNT = ${count}\n`
writeFileSync(join(root, 'src/lib/build-info.ts'), content)
console.log(`[build-info] COMMIT_COUNT = ${count}`)
